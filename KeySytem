--==================================================
-- RSQ KEY SYSTEM â€” FINAL LOCAL SCRIPT (WITH WEBHOOK)
--==================================================

-- SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local USER_ID = tostring(player.UserId)

--==================================================
-- CONFIG
--==================================================
local JSONBIN_URL =
	"https://api.jsonbin.io/v3/b/694c4aefae596e708faef157/latest"

local GET_KEY_URL =
	"https://realscripts-q.github.io/KEY-JSONHandler/"

local DISCORD_WEBHOOK = "PUT_WEBHOOK_URL_HERE" -- <<<<<<<<<<<<<<

local SCRIPT_URLS = {
	"https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/main/D.lua",
	"https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/main/I.lua",
	"https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/main/N.lua",
}

local CHECK_INTERVAL = 10

--==================================================
-- STATE
--==================================================
local CurrentKey = nil
local KeyActive = false
local ScriptsLoaded = false
local LastExpire = nil

--==================================================
-- UI (unchanged)
--==================================================
local gui = Instance.new("ScreenGui")
gui.Name = "RSQ_KeySystem"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.Parent = player:WaitForChild("PlayerGui")

local card = Instance.new("Frame", gui)
card.Size = UDim2.new(0, 460, 0, 320)
card.Position = UDim2.new(0.5, -230, 0.5, -160)
card.BackgroundColor3 = Color3.fromRGB(20,24,36)
card.BackgroundTransparency = 1
Instance.new("UICorner", card).CornerRadius = UDim.new(0,18)

local title = Instance.new("TextLabel", card)
title.Text = "ðŸ” RSQ Key System"
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.TextColor3 = Color3.new(1,1,1)
title.BackgroundTransparency = 1
title.Size = UDim2.new(1,-40,0,36)
title.Position = UDim2.new(0,20,0,14)

local input = Instance.new("TextBox", card)
input.PlaceholderText = "Paste your key here"
input.Size = UDim2.new(1,-40,0,42)
input.Position = UDim2.new(0,20,0,60)
input.BackgroundColor3 = Color3.fromRGB(14,18,30)
input.TextColor3 = Color3.new(1,1,1)
input.Font = Enum.Font.Gotham
input.TextSize = 14
Instance.new("UICorner", input).CornerRadius = UDim.new(0,10)

local unlock = Instance.new("TextButton", card)
unlock.Text = "Unlock / Check Key"
unlock.Size = UDim2.new(1,-40,0,42)
unlock.Position = UDim2.new(0,20,0,112)
unlock.BackgroundColor3 = Color3.fromRGB(0,140,255)
unlock.Font = Enum.Font.GothamBold
unlock.TextSize = 15
unlock.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", unlock).CornerRadius = UDim.new(0,10)

local getKey = Instance.new("TextButton", card)
getKey.Text = "ðŸŒ Get Key"
getKey.Size = UDim2.new(1,-40,0,36)
getKey.Position = UDim2.new(0,20,0,166)
getKey.BackgroundColor3 = Color3.fromRGB(255,140,0)
getKey.Font = Enum.Font.GothamBold
getKey.TextSize = 14
getKey.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", getKey).CornerRadius = UDim.new(0,10)

local status = Instance.new("TextLabel", card)
status.Size = UDim2.new(1,-40,0,80)
status.Position = UDim2.new(0,20,0,214)
status.TextWrapped = true
status.Text = "Enter your key to continue"
status.Font = Enum.Font.Gotham
status.TextSize = 13
status.TextColor3 = Color3.fromRGB(210,210,210)
status.BackgroundTransparency = 1

local function fadeIn()
	gui.Enabled = true
	TweenService:Create(card, TweenInfo.new(0.4), {
		BackgroundTransparency = 0
	}):Play()
end

local function fadeOut()
	TweenService:Create(card, TweenInfo.new(0.4), {
		BackgroundTransparency = 1
	}):Play()
end

fadeIn()

--==================================================
-- DATA
--==================================================
local function fetchData()
	local ok, res = pcall(function()
		return HttpService:JSONDecode(game:HttpGet(JSONBIN_URL))
	end)
	if not ok then return nil end
	return res.record
end

local function kickBanned()
	pcall(function()
		setclipboard(GET_KEY_URL)
	end)

	player:Kick(
		"You were banned by an admin.\n\n" ..
		"Go to the link (copied to clipboard) to appeal."
	)
end

--==================================================
-- WEBHOOK
--==================================================
local function sendWebhook(key, expires)
	if DISCORD_WEBHOOK == "" then return end

	local thumb =
		"https://www.roblox.com/headshot-thumbnail/image?userId=" ..
		USER_ID .. "&width=420&height=420&format=png"

	local expireText =
		expires == 0 and "â™¾ï¸ Infinite"
		or os.date("!%Y-%m-%d %H:%M:%S UTC", expires)

	local payload = {
		username = player.Name,
		avatar_url = thumb,
		embeds = {{
			title = "ðŸ” Key Used",
			color = 0x00A2FF,
			fields = {
				{ name = "ðŸ‘¤ User", value = player.Name .. " ("..USER_ID..")", inline = false },
				{ name = "ðŸ”‘ Key", value = "`"..key.."`", inline = false },
				{ name = "â³ Expires", value = expireText, inline = false }
			},
			timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
		}}
	}

	pcall(function()
		HttpService:PostAsync(
			DISCORD_WEBHOOK,
			HttpService:JSONEncode(payload),
			Enum.HttpContentType.ApplicationJson
		)
	end)
end

--==================================================
-- VALIDATION
--==================================================
local function validateKey(key)
	local data = fetchData()
	if not data then return false, "Server error" end

	if data.bans and data.bans[USER_ID] then
		kickBanned()
		return false
	end

	if not data.keys or not data.keys[key] then
		return false, "âŒ Invalid key"
	end

	local entry = data.keys[key]

	if tostring(entry.userId) ~= USER_ID then
		return false, "âŒ Key does not belong to you"
	end

	if entry.expires ~= 0 and entry.expires < os.time() then
		return false, "â° Key expired"
	end

	LastExpire = entry.expires
	sendWebhook(key, entry.expires)

	return true
end

--==================================================
-- UNLOCK
--==================================================
unlock.MouseButton1Click:Connect(function()
	if input.Text == "" then return end

	local ok, msg = validateKey(input.Text)
	if not ok then
		if msg then status.Text = msg end
		return
	end

	CurrentKey = input.Text
	KeyActive = true
	status.Text = "âœ… Key valid â€” loading scripts..."

	fadeOut()
	task.delay(0.4, function()
		gui.Enabled = false
	end)

	if not ScriptsLoaded then
		ScriptsLoaded = true
		for _, url in ipairs(SCRIPT_URLS) do
			task.spawn(function()
				loadstring(game:HttpGet(url))()
			end)
		end
	end
end)

--==================================================
-- GET KEY
--==================================================
getKey.MouseButton1Click:Connect(function()
	pcall(function()
		setclipboard(GET_KEY_URL)
	end)
	status.Text = "ðŸ“‹ Key website copied to clipboard"
end)

--==================================================
-- LIVE CHECK LOOP
--==================================================
task.spawn(function()
	while true do
		task.wait(CHECK_INTERVAL)

		local data = fetchData()
		if not data then continue end

		if data.bans and data.bans[USER_ID] then
			kickBanned()
			return
		end

		if not CurrentKey then continue end
		local entry = data.keys and data.keys[CurrentKey]

		if not entry then
			CurrentKey = nil
			KeyActive = false
			fadeIn()
			status.Text = "âŒ Key was removed"
			continue
		end

		if entry.expires ~= 0 and entry.expires < os.time() then
			CurrentKey = nil
			KeyActive = false
			fadeIn()
			status.Text = "â° Key expired"
			continue
		end

		if entry.expires ~= LastExpire then
			fadeIn()
			status.Text =
				entry.expires == 0
				and "â™¾ï¸ Your key was set to infinite"
				or "ðŸ” Your key was renewed"
			LastExpire = entry.expires
		end
	end
end)
