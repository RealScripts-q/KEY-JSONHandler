----------------------------------------------------
-- ðŸ”‘ RSQ KEY SYSTEM + MULTI SCRIPT LOADER (FINAL)
----------------------------------------------------

-- SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")

local PLAYER = Players.LocalPlayer

----------------------------------------------------
-- CONFIG
----------------------------------------------------

-- JSONBIN (PUBLIC READ)
local JSONBIN_URL =
"https://api.jsonbin.io/v3/b/694c4aefae596e708faef157/latest"

-- âœ… ALL SCRIPTS TO LOAD AFTER AUTH
local SCRIPT_URLS = {
	"https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/refs/heads/main/D.lua",
	"https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/refs/heads/main/I.lua",
	"https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/refs/heads/main/N.lua",
	"https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/refs/heads/main/TrackDataSecrete.lua",
	"https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/refs/heads/main/Iforgottoaddthis"
}

-- FILES
local KEY_FILE = "rsq_saved_key.txt"
local HWID_FILE = "rsq_hwid.txt"

----------------------------------------------------
-- UTIL
----------------------------------------------------

local function notify(text)
	StarterGui:SetCore("SendNotification", {
		Title = "RSQ",
		Text = text,
		Duration = 4
	})
end

----------------------------------------------------
-- HWID
----------------------------------------------------

local function getHWID()
	if not writefile or not readfile or not isfile then
		return "STUDIO"
	end
	if isfile(HWID_FILE) then
		return readfile(HWID_FILE)
	end
	local id = HttpService:GenerateGUID(false)
	writefile(HWID_FILE, id)
	return id
end

local HWID = getHWID()

----------------------------------------------------
-- FETCH KEYS
----------------------------------------------------

local function fetchKeys()
	local raw
	local ok = pcall(function()
		raw = game:HttpGet(JSONBIN_URL)
	end)
	if not ok then return nil end

	local decoded = HttpService:JSONDecode(raw)
	if not decoded or not decoded.record or not decoded.record.keys then
		return nil
	end
	return decoded.record.keys
end

----------------------------------------------------
-- VALIDATE KEY
----------------------------------------------------

local function validateKey(key)
	local keys = fetchKeys()
	if not keys then
		return false, "Database error"
	end

	local entry = keys[key]
	if not entry then
		return false, "Invalid key"
	end

	if tonumber(entry.userId) ~= PLAYER.UserId then
		return false, "Wrong user"
	end

	if tonumber(entry.expires) < os.time() then
		return false, "Key expired"
	end

	if entry.hwid and entry.hwid ~= HWID then
		return false, "HWID mismatch"
	end

	return true, entry.expires
end

----------------------------------------------------
-- LOAD ALL SCRIPTS (MULTI SCRIPT SUPPORT)
----------------------------------------------------

local function loadAllScripts()
	for _, url in ipairs(SCRIPT_URLS) do
		task.spawn(function()
			local src = game:HttpGet(url)
			loadstring(src)()
		end)
	end
end

----------------------------------------------------
-- GUI ROOT
----------------------------------------------------

local gui = Instance.new("ScreenGui")
gui.Name = "RSQ_GUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.Parent = PLAYER:WaitForChild("PlayerGui")

----------------------------------------------------
-- â±ï¸ TIMER HUD (TOP RIGHT)
----------------------------------------------------

local timerFrame = Instance.new("Frame", gui)
timerFrame.Size = UDim2.fromOffset(220, 46)
timerFrame.Position = UDim2.new(1, -230, 0, 20)
timerFrame.BackgroundColor3 = Color3.fromRGB(20,20,25)
timerFrame.BorderSizePixel = 0
Instance.new("UICorner", timerFrame).CornerRadius = UDim.new(0, 12)
timerFrame.Visible = false

local timerLabel = Instance.new("TextLabel", timerFrame)
timerLabel.Size = UDim2.new(1, -20, 1, 0)
timerLabel.Position = UDim2.fromOffset(10, 0)
timerLabel.BackgroundTransparency = 1
timerLabel.Font = Enum.Font.GothamBold
timerLabel.TextSize = 16
timerLabel.TextColor3 = Color3.new(1,1,1)
timerLabel.TextXAlignment = Left

-- Dragging
do
	local dragging, dragStart, startPos
	timerFrame.InputBegan:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = i.Position
			startPos = timerFrame.Position
		end
	end)
	UserInputService.InputChanged:Connect(function(i)
		if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
			local delta = i.Position - dragStart
			timerFrame.Position = UDim2.new(
				startPos.X.Scale,
				startPos.X.Offset + delta.X,
				startPos.Y.Scale,
				startPos.Y.Offset + delta.Y
			)
		end
	end)
	UserInputService.InputEnded:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)
end

----------------------------------------------------
-- ðŸŽ® CENTER AUTH GUI
----------------------------------------------------

local keyFrame = Instance.new("Frame", gui)
keyFrame.Size = UDim2.fromOffset(420, 150)
keyFrame.Position = UDim2.fromScale(0.5, 0.5)
keyFrame.AnchorPoint = Vector2.new(0.5, 0.5)
keyFrame.BackgroundColor3 = Color3.fromRGB(20,20,25)
keyFrame.BorderSizePixel = 0
Instance.new("UICorner", keyFrame).CornerRadius = UDim.new(0, 16)

local title = Instance.new("TextLabel", keyFrame)
title.Position = UDim2.fromOffset(16, 10)
title.Size = UDim2.new(1, -32, 22)
title.Text = "My Super Hub"
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.TextColor3 = Color3.fromRGB(240,240,240)
title.BackgroundTransparency = 1
title.TextXAlignment = Left

local subtitle = Instance.new("TextLabel", keyFrame)
subtitle.Position = UDim2.fromOffset(16, 32)
subtitle.Size = UDim2.new(1, -32, 18)
subtitle.Text = "hi, im ured."
subtitle.Font = Enum.Font.Gotham
subtitle.TextSize = 13
subtitle.TextColor3 = Color3.fromRGB(160,160,170)
subtitle.BackgroundTransparency = 1
subtitle.TextXAlignment = Left

local input = Instance.new("TextBox", keyFrame)
input.Position = UDim2.fromOffset(16, 60)
input.Size = UDim2.new(1, -32, 36)
input.PlaceholderText = "Enter Key"
input.ClearTextOnFocus = false
input.Font = Enum.Font.Gotham
input.TextSize = 14
input.TextColor3 = Color3.new(1,1,1)
input.BackgroundColor3 = Color3.fromRGB(30,30,36)
input.BorderSizePixel = 0
Instance.new("UICorner", input).CornerRadius = UDim.new(0, 10)

local submit = Instance.new("TextButton", keyFrame)
submit.Position = UDim2.fromOffset(16, 105)
submit.Size = UDim2.new(1, -32, 34)
submit.Text = "Submit"
submit.Font = Enum.Font.GothamBold
submit.TextSize = 14
submit.TextColor3 = Color3.new(1,1,1)
submit.BackgroundColor3 = Color3.fromRGB(80,90,255)
submit.BorderSizePixel = 0
Instance.new("UICorner", submit).CornerRadius = UDim.new(0, 10)

----------------------------------------------------
-- AUTH FLOW
----------------------------------------------------

local function onAuthenticated(expireTime)
	keyFrame.Visible = false
	timerFrame.Visible = true

	if writefile then
		writefile(KEY_FILE, input.Text)
	end

	loadAllScripts()

	task.spawn(function()
		while true do
			local remaining = expireTime - os.time()
			if remaining <= 0 then
				timerLabel.Text = "âŒ KEY EXPIRED"
				break
			end
			local h = math.floor(remaining / 3600)
			local m = math.floor((remaining % 3600) / 60)
			local s = remaining % 60
			timerLabel.Text = string.format("â± %02dh %02dm %02ds", h, m, s)
			task.wait(1)
		end
	end)
end

submit.MouseButton1Click:Connect(function()
	local key = input.Text:gsub("%s+", "")
	if key == "" then return end

	local valid, expires = validateKey(key)
	if not valid then
		notify(expires)
		return
	end

	onAuthenticated(expires)
end)

----------------------------------------------------
-- AUTO LOGIN (SAVED KEY)
----------------------------------------------------

if isfile and isfile(KEY_FILE) then
	local savedKey = readfile(KEY_FILE)
	local ok, expires = validateKey(savedKey)
	if ok then
		onAuthenticated(expires)
	else
		keyFrame.Visible = true
	end
else
	keyFrame.Visible = true
end
