<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tracker V2 â€“ Get Key</title>
<style>
body {
  background:#0f0f0f;
  color:#fff;
  font-family:Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.box {
  background:#1b1b1b;
  padding:25px;
  border-radius:10px;
  width:360px;
}
input, button {
  width:100%;
  padding:10px;
  margin-top:10px;
  border:none;
  border-radius:6px;
}
button {
  background:#0078ff;
  color:white;
  font-weight:bold;
  cursor:pointer;
}
.output {
  margin-top:15px;
  background:#000;
  padding:10px;
  border-radius:6px;
  word-break:break-all;
}
</style>
</head>
<body>

<div class="box">
  <h3>ðŸ”‘ Tracker V2 Key</h3>
  <input id="username" placeholder="Roblox Username">
  <button onclick="generate()">Get Key</button>
  <div class="output" id="out">Waitingâ€¦</div>
</div>

<script>
/* ================= CONFIG ================= */

const GITHUB_TOKEN = "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";
const OWNER = "RealScripts-q";
const REPO = "KEY-JSONHandler";
const FILE_PATH = "keys.json";

const EXPIRY_SECONDS = 60 * 60 * 24 * 7;
const SECRET = "TrackerV2_Private_Salt";

/* ================= UTILS ================= */

function hash(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) {
    h = (h << 5) - h + str.charCodeAt(i);
    h |= 0;
  }
  return Math.abs(h).toString(36).toUpperCase();
}

/* ================= MAIN ================= */

async function generate() {
  const out = document.getElementById("out");
  const username = document.getElementById("username").value.trim();

  if (!username) {
    out.innerText = "Enter a username";
    return;
  }

  out.innerText = "Verifying Roblox userâ€¦";

  let userId;

  /* ðŸ”Ž VERIFY ROBLOX USER */
  try {
    const robloxRes = await fetch(
      "https://users.roblox.com/v1/usernames/users",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usernames: [username] })
      }
    ).then(r => r.json());

    if (!robloxRes.data || !robloxRes.data[0]) {
      out.innerText = "Couldn't find player in database";
      return;
    }

    userId = robloxRes.data[0].id;

  } catch (e) {
    out.innerText = "Couldn't find player in database";
    return;
  }

  /* ðŸ“‚ FETCH keys.json */
  out.innerText = "Checking existing keysâ€¦";

  const fileRes = await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`,
    {
      headers: {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        Accept: "application/vnd.github+json"
      }
    }
  ).then(r => r.json());

  let data = {};
  if (fileRes.content) {
    data = JSON.parse(atob(fileRes.content));
  }

  /* ðŸš« BLOCK MULTIPLE USE */
  if (data[userId]) {
    out.innerText = "Key already generated for this user";
    return;
  }

  /* ðŸ”‘ GENERATE KEY */
  const key = "TV2-" + hash(userId + ":" + SECRET);
  const expires = Math.floor(Date.now() / 1000) + EXPIRY_SECONDS;

  data[userId] = { key, expires };

  /* ðŸ’¾ WRITE TO GITHUB */
  out.innerText = "Generating keyâ€¦";

  await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`,
    {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        Accept: "application/vnd.github+json",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: `Key issued for user ${userId}`,
        content: btoa(JSON.stringify(data, null, 2)),
        sha: fileRes.sha
      })
    }
  );

  /* âœ… DONE */
  out.innerText = key;
}
</script>

</body>
</html>
