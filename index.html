<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RSQ Key System | Ultra Update</title>

<style>
body {
  margin:0;
  background:#0b0e14;
  font-family:system-ui;
  color:white;
}
.hidden { display:none !important; }

/* Global Lockout Overlay */
#lockoutOverlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.95);
  z-index:9999;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
}

.panel {
  width:520px;
  background:#141822;
  border-radius:18px;
  padding:22px;
  box-shadow:0 0 60px rgba(0,120,255,.3);
  margin:auto;
  margin-top:10vh;
}

button,input,select,textarea {
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:8px;
  border:none;
  font-size:14px;
}

input,select,textarea {
  background:#0b0f18;
  color:white;
  border:1px solid #222;
}

button {
  background:linear-gradient(135deg,#4f7cff,#3fd2ff);
  font-weight:bold;
  cursor:pointer;
  text-transform: uppercase;
}
button:hover { filter: brightness(1.1); }
button:disabled { opacity: 0.3; cursor: not-allowed; }

button.danger { background:linear-gradient(135deg,#ff3b30,#ff453a); }
button.secondary { background:linear-gradient(135deg,#ff8a00,#ffb300); }
button.success { background:linear-gradient(135deg,#28cd41,#34c759); }

.status { text-align:center; margin-top:8px; font-size:13px; }
.keyDisplay { text-align:center; margin-top:6px; font-size:13px; color:#3fd2ff; word-break:break-all; }

.adminFull {
  position:fixed;
  inset:0;
  background:#0b0e14;
  padding:20px;
  overflow:auto;
  z-index: 100;
}

.keyRow {
  background:#111625;
  border-radius:10px;
  padding:12px;
  margin-bottom:12px;
  border: 1px solid rgba(255,255,255,0.05);
}

hr { opacity:.1; margin: 20px 0; }
</style>
</head>

<body>

<div id="lockoutOverlay" class="hidden">
    <h1 style="color:#ff3b30; font-size:40px;">üö´ ACCESS RESTRICTED</h1>
    <p id="lockoutReason">System Lock Active</p>
    <p id="myDeviceIdDisplay" style="font-family:monospace; background:#222; padding:10px; border-radius:5px; color:#3fd2ff;"></p>
</div>

<div id="userPanel" class="panel">
  <h2 style="text-align:center">üîê RSQ Key System</h2>

  <input id="userid" placeholder="Roblox UserId">
  <button id="genBtn">Generate / Recover Key</button>

  <div id="status" class="status"></div>
  <div id="keyOut" class="keyDisplay"></div>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
    <button id="adminBtn" class="danger">üëë Admin</button>
    <button id="appealBtn" class="secondary" onclick="showAppeal()">üì® Appeal</button>
  </div>
  <input id="adminInput" class="hidden" placeholder="Admin Master Key">
</div>

<div id="appealPanel" class="panel hidden">
    <h2 style="text-align:center">üì® SUBMIT APPEAL</h2>
    <input id="appealUser" placeholder="Roblox Username/ID">
    <textarea id="appealMsg" placeholder="Why should you be unbanned?" style="height:100px; resize:none;"></textarea>
    <button onclick="submitAppeal()" class="success">Submit Appeal</button>
    <button onclick="hideAppeal()" style="background:none; border:1px solid #444;">Cancel</button>
</div>

<div id="adminPanel" class="adminFull hidden">
  <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>üëë SYSTEM OVERSEER</h2>
      <button onclick="exitAdmin()" style="width:auto; padding:10px 30px;">EXIT ADMIN</button>
  </div>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; margin-top:20px;">
      <div>
          <h3>üîë KEY LOGS & CONTROLS</h3>
          <div id="keyLogs"></div>
          
          <h3>üñ•Ô∏è DEVICE REGISTRY</h3>
          <div id="deviceLogs"></div>
      </div>
      
      <div>
          <h3>‚è≥ TIMEOUTS & BANS</h3>
          <div id="banLogs"></div>
          
          <h3 style="margin-top:20px;">üìã PENDING APPEALS</h3>
          <div id="adminAppeals"></div>
      </div>
  </div>
</div>

<script>
/* CONFIG */
const BIN_ID = "694c4aefae596e708faef157";
const JSONBIN_KEY = "$2a$10$DgQd.qgYLB2nv9e9ZFktKeUUkzZfmqPnL4Fk7JLvnN/ASlctW.8Cu";
const ADMIN_MASTER_KEY = "roblox";
const KEY_LIFE = 86400;
const TEST_TIMEOUT = 10; // 10 Seconds for testing

/* HELPERS */
const now = () => Math.floor(Date.now()/1000);
const makeKey = () => "RSQ-" + crypto.randomUUID().replace(/-/g,"").slice(0,24).toUpperCase();

// DEVICE FINGERPRINT GETTER
function getDeviceId() {
    return btoa(navigator.userAgent + screen.width + navigator.language).slice(0, 16).toUpperCase();
}
const MY_DEVICE_ID = getDeviceId();

async function getData(){
  const r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`);
  return (await r.json()).record || {};
}

async function saveData(data){
  await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`,{
    method:"PUT",
    headers:{"Content-Type":"application/json","X-Master-Key":JSONBIN_KEY},
    body:JSON.stringify(data)
  });
}

/* INITIAL SECURITY CHECK */
async function checkSecurity() {
    const data = await getData();
    data.timeouts ||= {};
    data.bans ||= {};
    data.registry ||= {};

    // Auto-register device
    data.registry[MY_DEVICE_ID] = true;

    const isTimedOut = data.timeouts[MY_DEVICE_ID] && data.timeouts[MY_DEVICE_ID] > now();
    const isBanned = Object.values(data.keys || {}).some(k => k.deviceId === MY_DEVICE_ID && data.bans[k.userId]);

    if (isTimedOut || isBanned) {
        lockoutOverlay.classList.remove("hidden");
        myDeviceIdDisplay.textContent = "DEVICE ID: " + MY_DEVICE_ID;
        lockoutReason.textContent = isBanned ? "PERMANENT HARDWARE BAN" : "TEMPORARY TIMEOUT ACTIVE";
        return true;
    }
    return false;
}

window.onload = checkSecurity;

/* USER FLOW */
genBtn.onclick = async ()=>{
  if(await checkSecurity()) return;
  const uid = userid.value.trim();
  if(!/^\d+$/.test(uid)) return;

  const data = await getData();
  data.keys ||= {};
  data.bans ||= {};

  if(data.bans[uid]){
    status.textContent = "üö´ Access Denied: User Banned";
    return;
  }

  const key = makeKey();
  data.keys[key] = {
    userId: uid,
    deviceId: MY_DEVICE_ID,
    expires: now() + KEY_LIFE
  };

  await saveData(data);
  keyOut.textContent = key;
  status.textContent = "‚úÖ Key Active";
};

/* APPEALS */
function showAppeal() { userPanel.classList.add("hidden"); appealPanel.classList.remove("hidden"); }
function hideAppeal() { appealPanel.classList.add("hidden"); userPanel.classList.remove("hidden"); }

async function submitAppeal() {
    const data = await getData();
    data.appeals ||= [];
    data.appeals.push({ 
        user: appealUser.value, 
        msg: appealMsg.value, 
        deviceId: MY_DEVICE_ID,
        time: now()
    });
    await saveData(data);
    alert("Appeal Submitted");
    hideAppeal();
}

/* ADMIN LOGIC */
adminBtn.onclick = ()=>adminInput.classList.toggle("hidden");
adminInput.onchange = ()=>{
  if(adminInput.value === ADMIN_MASTER_KEY){
    userPanel.classList.add("hidden");
    adminPanel.classList.remove("hidden");
    refreshAdmin();
  }
};

async function adminCmd(type, target) {
    const data = await getData();
    data.timeouts ||= {};
    data.bans ||= {};

    if(type === 'timeout') {
        const dId = data.keys[target].deviceId;
        data.timeouts[dId] = now() + TEST_TIMEOUT;
        delete data.keys[target];
    }
    else if(type === 'ban') {
        data.bans[target] = true;
        // Perm timeout for all devices linked to this ID
        Object.values(data.keys).forEach(k => { if(k.userId === target) data.timeouts[k.deviceId] = 9999999999; });
    }
    else if(type === 'unban') {
        delete data.bans[target];
        // Remove infinite timeout
        Object.keys(data.timeouts).forEach(d => { if(data.timeouts[d] > 5000000000) delete data.timeouts[d]; });
    }
    else if(type === 'untimeout') {
        delete data.timeouts[target];
    }
    else if(type === 'renew') { data.keys[target].expires = now() + KEY_LIFE; }
    else if(type === 'inf') { data.keys[target].expires = 0; }

    await saveData(data);
    refreshAdmin();
}

async function refreshAdmin(){
  const data = await getData();
  
  // Render Keys
  keyLogs.innerHTML = "";
  Object.entries(data.keys || {}).forEach(([k, v]) => {
      const div = document.createElement("div");
      div.className = "keyRow";
      div.innerHTML = `<b>${k}</b><br>UID: ${v.userId} | DEV: ${v.deviceId}<br>`;
      
      const row = document.createElement("div");
      row.style.display = "grid"; row.style.gridTemplateColumns = "1fr 1fr 1fr 1fr"; row.style.gap="5px";
      
      const btnT = document.createElement("button"); btnT.className="danger"; btnT.textContent="T.O"; btnT.onclick=()=>adminCmd('timeout', k);
      const btnB = document.createElement("button"); btnB.className="danger"; btnB.textContent="BAN"; btnB.onclick=()=>adminCmd('ban', v.userId);
      const btnR = document.createElement("button"); btnR.className="success"; btnR.textContent="REN"; btnR.onclick=()=>adminCmd('renew', k);
      const btnI = document.createElement("button"); btnI.className="success"; btnI.textContent="INF"; btnI.onclick=()=>adminCmd('inf', k);
      
      row.append(btnT, btnB, btnR, btnI);
      div.appendChild(row);
      keyLogs.appendChild(div);
  });

  // Render Timeouts/Bans
  banLogs.innerHTML = "";
  Object.entries(data.bans || {}).forEach(([uid, val]) => {
      const div = document.createElement("div");
      div.className = "keyRow";
      div.innerHTML = `üö´ BANNED: ${uid} <button onclick="adminCmd('unban','${uid}')" class="success" style="width:auto; float:right; padding:5px 10px;">UNBAN</button>`;
      banLogs.appendChild(div);
  });
  Object.entries(data.timeouts || {}).forEach(([did, time]) => {
      if(time > now() && time < 5000000000) {
          const div = document.createElement("div");
          div.className = "keyRow";
          div.innerHTML = `‚è≥ TIMEOUT: ${did} <button onclick="adminCmd('untimeout','${did}')" class="success" style="width:auto; float:right; padding:5px 10px;">LIFT</button>`;
          banLogs.appendChild(div);
      }
  });

  // Render Appeals
  adminAppeals.innerHTML = "";
  (data.appeals || []).forEach((a, index) => {
      const div = document.createElement("div");
      div.className = "keyRow";
      div.innerHTML = `<b>${a.user}</b>: ${a.msg}<br><small>Device: ${a.deviceId}</small>`;
      adminAppeals.appendChild(div);
  });
}

function exitAdmin(){ adminPanel.classList.add("hidden"); userPanel.classList.remove("hidden"); }
</script>
</body>
</html>
